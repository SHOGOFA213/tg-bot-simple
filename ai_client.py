import time
import random

class OpenRouterError(Exception):
    """–ö–ª–∞—Å—Å –æ—à–∏–±–∫–∏ OpenRouter —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    pass


def chat_once(messages, model, temperature=0.7, max_tokens=400):
    """
    –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—â–µ–Ω–∏—è —Å –ò–ò.
    –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 500, 502, 503, 504.
    """
    start = time.time()
    question = messages[-1]["content"]

    # --- –°–ª—É—á–∞–π–Ω–æ–µ —ç–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫ (5% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å) ---
    possible_errors = [None, None, None, 500, 502, 503, 504]
    err = random.choice(possible_errors)
    if err in (500, 502, 503, 504):
        messages_for_user = {
            500: "–û—à–∏–±–∫–∞ 500 ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ OpenRouter. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            502: "–û—à–∏–±–∫–∞ 502 ‚Äî –ø–ª–æ—Ö–æ–π —à–ª—é–∑. –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω.",
            503: "–û—à–∏–±–∫–∞ 503 ‚Äî —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.",
            504: "–û—à–∏–±–∫–∞ 504 ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.",
        }
        raise OpenRouterError(messages_for_user[err])

    # --- –≠–º—É–ª—è—Ü–∏—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ---
    fake_answers = [
        "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! ü§î –Ø –¥—É–º–∞—é, —á—Ç–æ...",
        "–•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä —Ç–µ–º—ã! –í–æ—Ç —á—Ç–æ —è –¥—É–º–∞—é:",
        "–ü–æ–∑–≤–æ–ª—å –æ–±—ä—è—Å–Ω–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–æ:",
        "–î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –≤–º–µ—Å—Ç–µ:",
    ]
    response = random.choice(fake_answers) + f" {question}"

    # --- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ (–≤ –º—Å) ---
    ms = int((time.time() - start) * 1000)

    return response, ms
